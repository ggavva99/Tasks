<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Vulnerability Report</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <style>
        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 5vh;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        td a {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="title-container">
        <h2>Vulnerability Report</h2>
    </div>

    <label><b>Upload CSV File:</b></label>
    <input type="file" accept=".csv" onchange="handleFileUpload(event)">
    <br><br>

    <label><b>Select Asset Owner:</b></label>
    <select id="assetOwner" onchange="filterVulnerabilities()">
        <option value="">Select an Asset Owner</option>
    </select>
    <br><br>

    <h3>Vulnerabilities</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Vulnerability Title</th>
                <th>Risk Score</th>
                <th>Age</th>
            </tr>
        </thead>
        <tbody id="vulnerabilityTableBody"></tbody>
    </table>
    <br>

    <div id="details"></div>

    <script>
        let csvRows = [];  // Store parsed rows in memory after streaming
        let assetOwnersSet = new Set();

        function handleFileUpload(event) {
            const file = event.target.files[0];
            csvRows = [];
            assetOwnersSet.clear();

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                worker: true, // ✅ offload parsing to web worker
                step: function (results) {
                    const row = results.data;
                    csvRows.push(row);
                    if (row[' Asset Owner']) {  // ✅ Adjust based on exact column name
                        assetOwnersSet.add(row[' Asset Owner'].trim());
                    }
                },
                complete: function () {
                    populateAssetOwners();
                }
            });
        }

        function populateAssetOwners() {
            const select = document.getElementById("assetOwner");
            select.innerHTML = "<option value=''>Select an Asset Owner</option>";
            assetOwnersSet.forEach(owner => {
                const option = document.createElement("option");
                option.value = owner;
                option.textContent = owner;
                select.appendChild(option);
            });
        }

        function filterVulnerabilities() {
            const selectedOwner = document.getElementById("assetOwner").value;
            const tbody = document.getElementById("vulnerabilityTableBody");
            tbody.innerHTML = "";

            if (!selectedOwner) return;

            // Stream-filter rows (keeps it lightweight)
            const filtered = csvRows.filter(row =>
                row[' Asset Owner'] && row[' Asset Owner'].trim() === selectedOwner
            );

            // Optional sort by Risk Score
            filtered.sort((a, b) => parseFloat(b['Risk Score']) - parseFloat(a['Risk Score']));

            filtered.forEach(row => {
                const tr = document.createElement("tr");

                const tdTitle = document.createElement("td");
                const a = document.createElement("a");
                a.href = "#";
                a.textContent = row['VulnerabilityTitte'] || 'N/A';
                a.onclick = () => showDetails(row);
                tdTitle.appendChild(a);

                const tdRisk = document.createElement("td");
                tdRisk.textContent = row['Risk Score'] || 'N/A';

                const tdAge = document.createElement("td");
                tdAge.textContent = row['Vulnerability age'] || 'N/A';

                tr.appendChild(tdTitle);
                tr.appendChild(tdRisk);
                tr.appendChild(tdAge);
                tbody.appendChild(tr);
            });
        }

        function showDetails(row) {
            let detailsHtml = '<h3>Details</h3><table border="1">';
            for (const [key, value] of Object.entries(row)) {
                detailsHtml += `<tr><td><b>${key.trim()}</b></td><td>${value}</td></tr>`;
            }
            detailsHtml += '</table>';
            document.getElementById("details").innerHTML = detailsHtml;
        }
    </script>

</body>

</html>
