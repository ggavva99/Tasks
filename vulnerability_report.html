<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Report</title>
    <style>
        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 5vh;
        }
    </style>
    <script>
        let csvData = [];
        let headers = [];

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split("\n").filter(line => line.trim() !== "");
                headers = lines[0].split(",").map(h => h.trim()); // Trim headers
                csvData = lines.slice(1).map(line => line.split(","));
                populateAssetOwners();
            };
            reader.readAsText(file);
        }

        function populateAssetOwners() {
            const assetOwnerIndex = headers.findIndex(h => h === 'Asset Owner' || h.trim() === 'Asset Owner' || h === ' Asset Owner');
            if (assetOwnerIndex === -1) {
                alert('Asset Owner column not found!');
                return;
            }

            const assetOwners = new Set();
            csvData.forEach(row => {
                if (row.length > assetOwnerIndex) {
                    assetOwners.add(row[assetOwnerIndex].trim());
                }
            });

            const select = document.getElementById("assetOwner");
            select.innerHTML = "<option value=''>Select an Asset Owner</option>";
            assetOwners.forEach(owner => {
                if (owner) {  // Ensure owner is not empty
                    const option = document.createElement("option");
                    option.value = owner;
                    option.textContent = owner;
                    select.appendChild(option);
                }
            });
        }

        function filterVulnerabilities() {
            const selectedOwner = document.getElementById("assetOwner").value;
            const tbody = document.getElementById("vulnerabilityTableBody");
            tbody.innerHTML = "";

            const assetOwnerIndex = headers.findIndex(h => h === 'Asset Owner' || h.trim() === 'Asset Owner' || h === ' Asset Owner');
            const titleIndex = headers.findIndex(h => h.includes('VulnerabilityTitte'));
            const riskIndex = headers.findIndex(h => h.includes('Risk Score'));
            const ageIndex = headers.findIndex(h => h.includes('Vulnerability age'));

            let filteredRows = csvData.filter(row => row.length > assetOwnerIndex && row[assetOwnerIndex].trim() === selectedOwner);

            filteredRows.sort((a, b) => parseFloat(b[riskIndex]) - parseFloat(a[riskIndex]));

            filteredRows.forEach(row => {
                const tr = document.createElement("tr");

                const tdTitle = document.createElement("td");
                const a = document.createElement("a");
                a.href = "#";
                a.textContent = row[titleIndex];
                a.onclick = () => showDetails(row);
                tdTitle.appendChild(a);

                const tdRiskScore = document.createElement("td");
                tdRiskScore.textContent = row[riskIndex];

                const tdAge = document.createElement("td");
                tdAge.textContent = row[ageIndex];

                tr.appendChild(tdTitle);
                tr.appendChild(tdRiskScore);
                tr.appendChild(tdAge);
                tbody.appendChild(tr);
            });
        }

        function showDetails(row) {
            const detailHTML = headers.map((header, index) =>
                `<tr><td><b>${header.trim()}</b></td><td>${row[index]}</td></tr>`
            ).join("");

            document.getElementById("details").innerHTML = `
                <h3>Details for Vulnerability: ${row[headers.findIndex(h => h.includes('VulnerabilityTitte'))]}</h3>
                <table border='1'>${detailHTML}</table>
            `;
        }
    </script>
</head>

<body>

    <div class="title-container">
        <h2>Vulnerability Report</h2>
    </div>

    <label><b>Upload CSV File:</b></label>
    <input type="file" accept=".csv" onchange="handleFileUpload(event)">
    <br><br>

    <label><b>Select Asset Owner:</b></label>
    <select id="assetOwner" onchange="filterVulnerabilities()">
        <option value="">Select an Asset Owner</option>
    </select>
    <br><br>

    <h3>Vulnerabilities</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Vulnerability Title</th>
                <th>Vulnerability Risk Score</th>
                <th>Vulnerability Age</th>
            </tr>
        </thead>
        <tbody id="vulnerabilityTableBody"></tbody>
    </table>
    <br>

    <div id="details"></div>

</body>

</html>
