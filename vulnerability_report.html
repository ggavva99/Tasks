<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vulnerability Report</title>
    <style>
        .title-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 5vh;
        }
    </style>
    <script>
        let csvData = [];

        function handleFileUpload(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function (e) {
                const lines = e.target.result.split("\n").map(line => line.replace(/\r/g, '')); // âœ… Clean \r
                csvData = lines.map(line => line.split(","));
                console.log("CSV Loaded Rows:", csvData.length);
                populateAssetOwners();
            };
            reader.readAsText(file);
        }

        function populateAssetOwners() {
            const assetOwners = new Set();
            csvData.slice(1).forEach((row, index) => {
                if (row.length > 13) {
                    const owner = row[13].trim();
                    if (owner) assetOwners.add(owner);
                } else {
                    console.log(`Skipping row ${index + 2} due to insufficient columns:`, row);
                }
            });

            const select = document.getElementById("assetOwner");
            select.innerHTML = "<option value=''>Select an Asset Owner</option>";
            assetOwners.forEach(owner => {
                const option = document.createElement("option");
                option.value = owner;
                option.textContent = owner;
                select.appendChild(option);
            });
        }

        function filterVulnerabilities() {
            const selectedOwner = document.getElementById("assetOwner").value;
            console.log("Selected Asset Owner for Filtering:", selectedOwner);

            const tbody = document.getElementById("vulnerabilityTableBody");
            tbody.innerHTML = "";

            if (!selectedOwner) {
                console.log("No Asset Owner selected");
                return;
            }

            const filteredRows = csvData.slice(1).filter((row) => {
                if (row.length > 13) {
                    const owner = row[13].trim();
                    return owner === selectedOwner;
                }
                return false;
            });

            console.log("Filtered Rows Count:", filteredRows.length);

            // Sort by Risk Score descending (assuming column 5 is Risk Score)
            filteredRows.sort((a, b) => parseFloat(b[5] || 0) - parseFloat(a[5] || 0));

            filteredRows.forEach(row => {
                const tr = document.createElement("tr");

                const tdTitle = document.createElement("td");
                const a = document.createElement("a");
                a.href = "#";
                a.textContent = row[4];
                a.onclick = () => showDetails(row);
                tdTitle.appendChild(a);

                const tdRiskScore = document.createElement("td");
                tdRiskScore.textContent = row[5];

                const tdAge = document.createElement("td");
                tdAge.textContent = row[12];

                tr.appendChild(tdTitle);
                tr.appendChild(tdRiskScore);
                tr.appendChild(tdAge);
                tbody.appendChild(tr);
            });
        }

        function showDetails(row) {
            document.getElementById("details").innerHTML = `
                <h3>Details for Vulnerability: ${row[4]}</h3>
                <table border='1'>
                    <tr><th>Host Name</th><th>IP Address</th><th>OS Name</th><th>OS Version</th><th>Severity Level</th><th>Vulnerability Age</th><th>Vulnerability Risk Score</th><th>Custom Tag</th></tr>
                    <tr>
                        <td>${row[0]}</td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td>${row[8]}</td>
                        <td>${row[12]}</td>
                        <td>${row[5]}</td>
                        <td>${row[14]}</td>
                    </tr>
                </table>
            `;
        }
    </script>
</head>

<body>

    <div class="title-container">
        <h2>Vulnerability Report</h2>
    </div>

    <label><b>Upload CSV File:</b></label>
    <input type="file" accept=".csv" onchange="handleFileUpload(event)">
    <br><br>

    <label><b>Select Asset Owner:</b></label>
    <select id="assetOwner" onchange="filterVulnerabilities()">
        <option value="">Select an Asset Owner</option>
    </select>
    <br><br>

    <h3>Vulnerabilities</h3>
    <table border="1">
        <thead>
            <tr>
                <th>Vulnerability Title</th>
                <th>Vulnerability Risk Score</th>
                <th>Vulnerability Age</th>
            </tr>
        </thead>
        <tbody id="vulnerabilityTableBody"></tbody>
    </table>
    <br>

    <div id="details"></div>

</body>

</html>
